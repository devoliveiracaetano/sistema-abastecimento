import React, { useState, useContext, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { CaminhoesContext } from "../contexts/CaminhoesContext";
import "./CadastroCaminhoes.css";

export default function CadastroCaminhoes() {
  const navigate = useNavigate();
  const { adicionarCaminhao } = useContext(CaminhoesContext);

  const [placa, setPlaca] = useState("");
  const [modelo, setModelo] = useState("");
  const [ano, setAno] = useState("");
  const [foto, setFoto] = useState(null);
  const [compartimentos, setCompartimentos] = useState([
    { nome: "Compartimento 1", capacidade: "" },
  ]);
  const [status, setStatus] = useState("Ativo");
  const [capacidadeTotal, setCapacidadeTotal] = useState(0);
  const [vencimentoDoc, setVencimentoDoc] = useState("");

  // Calcula a soma total das capacidades sempre que compartimentos mudam
  useEffect(() => {
    const total = compartimentos.reduce((acc, c) => {
      const valor = parseFloat(c.capacidade) || 0;
      return acc + valor;
    }, 0);
    setCapacidadeTotal(total);
  }, [compartimentos]);

  const handleFotoChange = (e) => {
    if (e.target.files && e.target.files[0]) {
      setFoto(URL.createObjectURL(e.target.files[0]));
    }
  };

  const handleAdicionarCompartimento = () => {
    const novoIndex = compartimentos.length + 1;
    setCompartimentos([...compartimentos, { nome: `Compartimento ${novoIndex}`, capacidade: "" }]);
  };

  const handleCompartimentoChange = (index, valor) => {
    const novos = [...compartimentos];
    novos[index].capacidade = valor;
    setCompartimentos(novos);
  };

  const handleSalvar = () => {
    const novoCaminhao = {
      placa,
      modelo,
      ano,
      foto,
      compartimentos: compartimentos.map((c) => ({
        nome: c.nome,
        capacidade: c.capacidade + " litros",
      })),
      capacidadeTotal: capacidadeTotal + " litros",
      status,
      vencimentoDoc,
    };
    adicionarCaminhao(novoCaminhao);
    navigate("/lista-caminhoes");
  };

  return (
    <div className="cadastro-caminhoes-container">
      <h1>Cadastro de Caminhões</h1>

      <div className="form-group">
        <label>Placa</label>
        <input type="text" value={placa} onChange={(e) => setPlaca(e.target.value)} />
      </div>

      <div className="form-group">
        <label>Modelo</label>
        <input type="text" value={modelo} onChange={(e) => setModelo(e.target.value)} />
      </div>

      <div className="form-group">
        <label>Ano</label>
        <input type="number" value={ano} onChange={(e) => setAno(e.target.value)} />
      </div>

      <div className="form-group">
        <label>Status de Manutenção</label>
        <select value={status} onChange={(e) => setStatus(e.target.value)}>
          <option value="Ativo">Ativo</option>
          <option value="Em Manutenção">Em Manutenção</option>
        </select>
      </div>

      <div className="form-group">
        <label>Vencimento da Documentação</label>
        <input type="date" value={vencimentoDoc} onChange={(e) => setVencimentoDoc(e.target.value)} />
      </div>

      <div className="form-group">
        <label>Foto</label>
        <input type="file" accept="image/*" onChange={handleFotoChange} />
        {foto && <img src={foto} alt="Caminhão" className="foto-caminhao" />}
      </div>

      <h2>Compartimentos</h2>
      {compartimentos.map((c, i) => (
        <div className="form-group" key={i}>
          <label>{c.nome}</label>
          <input
            type="number"
            placeholder="Capacidade em litros"
            value={c.capacidade}
            onChange={(e) => handleCompartimentoChange(i, e.target.value)}
          />
        </div>
      ))}
      <button className="add-comp-btn" onClick={handleAdicionarCompartimento}>
        Adicionar Compartimento
      </button>

      <div className="form-group">
        <label>Capacidade Total</label>
        <input type="text" value={`${capacidadeTotal} litros`} readOnly />
      </div>

      <div className="bottom-buttons">
        <button className="salvar-btn" onClick={handleSalvar}>Salvar</button>
        <button className="voltar-btn" onClick={() => navigate("/lista-caminhoes")}>Voltar</button>
      </div>
    </div>
  );
}
